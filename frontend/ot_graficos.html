<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Dashboard Gerencial - CONMETAL</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root { 
        --primary: #1f3b4b; --secondary: #334155; --accent: #3b82f6; 
        --bg-main: #f8fafc; --bg-card: #ffffff; --border: #e2e8f0; 
        --text-main: #1e293b; --text-muted: #64748b;
        --chart-blue: #3b82f6; --chart-green: #10b981; --chart-red: #ef4444; --chart-orange: #f59e0b; --chart-purple: #8b5cf6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
    
    .sidebar { width: 280px; background: var(--primary); color: white; display: flex; flex-direction: column; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
    .sidebar-header { padding: 28px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 20px; }
    .logo-img { width: 40px; height: 40px; object-fit: contain; border-radius: 8px; background: white; padding: 2px; }

    .nav-links { padding: 24px 16px; flex: 1; }
    .nav-item { display: flex; gap: 12px; padding: 12px 16px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 4px; transition: 0.2s; font-size: 14px; font-weight: 500; align-items: center; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: var(--accent); color: white; font-weight: 600; }
    
    .main-content { margin-left: 280px; padding: 30px 40px; flex: 1; overflow-y: auto; }
    
    .header-page { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: end; }
    .page-title { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
    .page-subtitle { font-size: 14px; color: var(--text-muted); font-weight: 500; margin-top: 4px; }
    .date-badge { background: white; padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); font-size: 13px; font-weight: 600; color: var(--text-muted); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 30px; }
    .kpi-card { background: white; padding: 20px 24px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: space-between; height: 110px; transition: transform 0.2s; border-left: 4px solid transparent; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .kpi-label { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { font-size: 32px; font-weight: 800; color: var(--primary); margin-top: 5px; }
    .kpi-icon { align-self: flex-end; width: 32px; height: 32px; border-radius: 8px; display: grid; place-items: center; font-size: 16px; }
    
    .kpi-blue { border-left-color: var(--chart-blue); } .kpi-blue .kpi-icon { background: #eff6ff; color: var(--chart-blue); }
    .kpi-orange { border-left-color: var(--chart-orange); } .kpi-orange .kpi-icon { background: #fff7ed; color: var(--chart-orange); }
    .kpi-purple { border-left-color: var(--chart-purple); } .kpi-purple .kpi-icon { background: #f5f3ff; color: var(--chart-purple); }
    .kpi-green { border-left-color: var(--chart-green); } .kpi-green .kpi-icon { background: #ecfdf5; color: var(--chart-green); }

    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
    .chart-card { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
    .chart-header { margin-bottom: 20px; }
    .chart-title { font-size: 16px; font-weight: 700; color: var(--primary); }
    .chart-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .chart-container { position: relative; height: 300px; width: 100%; }
</style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header"><img src="logo.png" class="logo-img" alt="Logo"><span>CONMETAL</span></div>
    <nav class="nav-links">
        <a href="index.html" class="nav-item">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> 
            Ingreso OT
        </a>
        <a href="ot_listado.html" class="nav-item">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg> 
            Visualizaciones OT
        </a>
        <a href="ot_graficos.html" class="nav-item active">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
            </svg> 
            Reportes Gr√°ficos
        </a>
    </nav>
</div>

<div class="main-content">
    <div class="header-page">
        <div>
            <div class="page-title">Dashboard de Mantenimiento</div>
            <div class="page-subtitle">Indicadores clave de desempe√±o</div>
        </div>
        <div class="date-badge" id="fechaHoy">...</div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card kpi-blue">
            <div><div class="kpi-label">Total √ìrdenes</div><div class="kpi-value" id="kpi-total">0</div></div>
            <div class="kpi-icon">üìã</div>
        </div>
        <div class="kpi-card kpi-orange">
            <div><div class="kpi-label">Pendientes</div><div class="kpi-value" id="kpi-pendientes">0</div></div>
            <div class="kpi-icon">‚è≥</div>
        </div>
        <div class="kpi-card kpi-purple">
            <div><div class="kpi-label">En Ejecuci√≥n</div><div class="kpi-value" id="kpi-proceso">0</div></div>
            <div class="kpi-icon">‚öôÔ∏è</div>
        </div>
        <div class="kpi-card kpi-green">
            <div><div class="kpi-label">Finalizadas</div><div class="kpi-value" id="kpi-finalizadas">0</div></div>
            <div class="kpi-icon">‚úÖ</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Desempe√±o y Carga Laboral por Encargado</div>
                <div class="chart-subtitle">Estado de √≥rdenes asignadas por t√©cnico</div>
            </div>
            <div class="chart-container"><canvas id="chartCarga"></canvas></div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Top 5 Tipos de Falla</div>
                <div class="chart-subtitle">Distribuci√≥n de incidencias</div>
            </div>
            <div class="chart-container" style="height:250px"><canvas id="chartFallas"></canvas></div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Equipos Cr√≠ticos (Top 5)</div>
                <div class="chart-subtitle">M√°quinas con mayor tasa de falla</div>
            </div>
            <div class="chart-container"><canvas id="chartMaquinas"></canvas></div>
        </div>

        <div class="chart-card">
            <div class="chart-header"><div class="chart-title">Estado Global</div></div>
            <div class="chart-container" style="height:250px"><canvas id="chartEstado"></canvas></div>
        </div>
    </div>
</div>

<script>
    document.getElementById('fechaHoy').textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('http://127.0.0.1:8000/api/ot-resumen/');
            const data = await res.json();

            document.getElementById('kpi-total').textContent = data.kpis.total;
            document.getElementById('kpi-pendientes').textContent = data.kpis.pendientes;
            document.getElementById('kpi-proceso').textContent = data.kpis.proceso;
            document.getElementById('kpi-finalizadas').textContent = data.kpis.finalizadas;

            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';
            Chart.defaults.scale.grid.color = '#f1f5f9';
            
            new Chart(document.getElementById('chartCarga'), {
                type: 'bar',
                data: {
                    labels: data.carga_laboral.map(x => x.encargado),
                    datasets: [
                        { label: 'Finalizadas', data: data.carga_laboral.map(x => x.finalizadas), backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'En Ejecuci√≥n', data: data.carga_laboral.map(x => x.proceso), backgroundColor: '#8b5cf6', borderRadius: 4 },
                        { label: 'Pendientes', data: data.carga_laboral.map(x => x.pendientes), backgroundColor: '#f59e0b', borderRadius: 4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { position: 'top' } } }
            });

            new Chart(document.getElementById('chartFallas'), {
                type: 'doughnut',
                data: {
                    labels: data.resumen_tipo.length ? data.resumen_tipo.map(x => x.tipo_falla || 'N/A') : ['Sin datos'],
                    datasets: [{ data: data.resumen_tipo.length ? data.resumen_tipo.map(x => x.total) : [1], backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#cbd5e1'], borderWidth: 0, hoverOffset: 4 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } }, cutout: '70%' }
            });

            new Chart(document.getElementById('chartMaquinas'), {
                type: 'bar',
                data: {
                    labels: data.resumen_maquina.map(x => x.maquina),
                    datasets: [{ label: 'Intervenciones', data: data.resumen_maquina.map(x => x.total), backgroundColor: '#1f3b4b', borderRadius: 4, barThickness: 25 }]
                },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            new Chart(document.getElementById('chartEstado'), {
                type: 'pie',
                data: {
                    labels: data.resumen_estado.map(x => mapEstado[x.estado] || x.estado),
                    datasets: [{ data: data.resumen_estado.map(x => x.total), backgroundColor: data.resumen_estado.map(x => colorEstado[x.estado] || '#ccc'), borderWidth: 2, borderColor: '#ffffff' }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } } }
            });

        } catch(e) { console.error("Error cargando gr√°ficos:", e); }
    });
</script>
</body>
</html>