<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Ingreso OT - CONMETAL</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* --- ESTILO MODERNO UNIFICADO --- */
    :root {
        --primary: #1f3b4b; --secondary: #334155; --accent: #3b82f6;
        --bg-body: #f1f5f9; --bg-card: #ffffff; --border: #e2e8f0;
        --text-primary: #0f172a; --text-secondary: #64748b;
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        /* Colores de Inputs */
        --input-bg: #f8fafc; --input-focus: #ffffff;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden; }

    /* SIDEBAR (Estilo Oscuro) */
    .sidebar { width: 280px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.3); position: fixed; top:0; bottom:0; left:0; }
    .sidebar-header { padding: 28px 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 8px; display: grid; place-items: center; font-weight: 800; font-size: 20px; }
    .sidebar-brand { font-weight: 700; font-size: 20px; letter-spacing: -0.5px; }
    .nav-links { padding: 24px 12px; flex: 1; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 4px; font-size: 14px; font-weight: 500; transition: 0.2s; }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
    .nav-item.active { background: var(--accent); color: white; font-weight: 600; }

    /* CONTENIDO */
    .content-area { margin-left: 280px; flex: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; }

    /* TARJETA FORMULARIO */
    .form-card { 
        background: var(--bg-card); width: 100%; max-width: 1000px; 
        border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
        border: 1px solid var(--border); overflow: hidden; margin-bottom: 50px; 
    }

    .form-header { padding: 24px 32px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .form-title { font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .ot-badge { background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; text-align: right; }
    .ot-label { font-size: 10px; text-transform: uppercase; opacity: 0.7; font-weight: 600; }
    .ot-input { background: transparent; border: none; color: white; font-weight: 700; font-size: 16px; width: 140px; text-align: right; }

    .form-body { padding: 32px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
    .full { grid-column: span 2; }

    label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
    input, select, textarea { 
        width: 100%; padding: 10px 12px; border: 1px solid var(--border); 
        border-radius: 8px; font-size: 14px; color: var(--text-primary); 
        background: var(--input-bg); transition: 0.2s; font-family: inherit; 
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    
    .bg-yellow { background-color: #fffbeb; border-color: #fcd34d; }
    .bg-green { background-color: #f0fdf4; border-color: #86efac; }

    /* TABLAS */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin: 32px 0 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    .section-title { font-size: 14px; font-weight: 700; color: var(--primary); text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    .btn-add { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
    .btn-add:hover { background: #2563eb; transform: translateY(-1px); }

    .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 24px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .modern-table th { background: #f8fafc; padding: 12px 16px; text-align: left; font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--border); }
    .modern-table td { padding: 10px 16px; border-bottom: 1px solid var(--border); background: #fff; }
    .table-input { width: 100%; padding: 8px; border: 1px solid transparent; background: transparent; }
    .table-input:hover { background: #f1f5f9; border-radius: 4px; }
    .table-input:focus { background: white; border: 1px solid var(--accent); border-radius: 4px; }
    
    .btn-del { width: 32px; height: 32px; background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2; border-radius: 6px; display: grid; place-items: center; cursor: pointer; transition: 0.2s; }
    .btn-del:hover { background: var(--danger); color: white; border-color: var(--danger); }

    .form-footer { padding: 24px 32px; background: #f8fafc; border-top: 1px solid var(--border); text-align: right; }
    .btn-save { background: var(--primary); color: white; border: none; padding: 12px 32px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-save:hover { background: #1e293b; transform: translateY(-2px); }
</style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header"><div class="logo-icon">C</div> <span class="sidebar-brand">CONMETAL</span></div>
    <nav class="nav-links">
        <a href="index.html" class="nav-item active">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Ingreso OT
        </a>
        <a href="ot_listado.html" class="nav-item">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg> Visualizaciones OT
        </a>
        <a href="ot_graficos.html" class="nav-item">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Reportes Gr√°ficos
        </a>
    </nav>
</div>

<div class="content-area">
    <form id="ordenTrabajoForm" class="form-card">
        <div class="form-header">
            <div class="form-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--accent)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                Detalle de la Orden
            </div>
            <div class="ot-badge">
                <div class="ot-label">NUMERO DE ORDEN DE TRABAJO</div>
                <input type="text" id="numeroOt" name="numeroOt" class="ot-input" readonly placeholder="...">
            </div>
        </div>

        <div class="form-body">
            <div class="grid-2">
                <div><label>Fecha Creaci√≥n</label><input type="date" id="fechaCreacion" required></div>
                <div><label>Equipo / M√°quina</label><input type="text" id="equipoMaquina" class="bg-yellow" required></div>
                <div class="full"><label>Descripci√≥n</label><input type="text" id="descripcion"></div>
                <div><label>Marca</label><input type="text" id="marca" class="bg-yellow"></div>
                <div><label>Modelo</label><input type="text" id="modelo" class="bg-yellow"></div>
                <div><label>Ubicaci√≥n</label><input type="text" id="ubicacion"></div>
                <div><label>Tipo Acci√≥n</label><input type="text" id="tipoAccion"></div>
                <div><label>Od√≥metro</label><input type="number" id="odometro"></div>
                <div><label>Responsable</label><input type="text" id="responsableEjecucion" class="bg-green" required></div>
                <div class="full"><label>Supervisor</label>
                    <select id="supervisor">
                        <option value="" disabled selected>Seleccione Especialidad...</option>
                        <option value="Mec√°nico">Mec√°nico</option>
                        <option value="El√©ctrico">El√©ctrico</option>
                        <option value="Electr√≥nica/Automatizaci√≥n">Electr√≥nica/Automatizaci√≥n</option>
                    </select>
                </div>
                <div><label>Fecha Planificada</label><input type="date" id="fechaPlanificada"></div>
            </div>

            <div class="section-header">
                <span class="section-title">Tareas a Ejecutar</span>
                <button type="button" class="btn-add" onclick="addRow('tareas')">+ Agregar</button>
            </div>
            <table class="modern-table">
                <thead><tr><th width="40" style="text-align:center">#</th><th>Detalle</th><th width="140">Tiempo Est.</th><th width="140">Tiempo Real</th><th width="40"></th></tr></thead>
                <tbody id="tareas-container"></tbody>
            </table>

            <div class="section-header">
                <span class="section-title">Repuestos Requeridos</span>
                <button type="button" class="btn-add" onclick="addRow('repuestos')">+ Agregar</button>
            </div>
            <table class="modern-table">
                <thead><tr><th width="40" style="text-align:center">#</th><th width="150">C√≥digo</th><th>Descripci√≥n</th><th width="100">Cant.</th><th width="40"></th></tr></thead>
                <tbody id="repuestos-container"></tbody>
            </table>

            <div class="section-header">
                <span class="section-title">Insumos Requeridos</span>
                <button type="button" class="btn-add" onclick="addRow('insumos')">+ Agregar</button>
            </div>
            <table class="modern-table">
                <thead><tr><th width="40" style="text-align:center">#</th><th width="150">C√≥digo</th><th>Descripci√≥n</th><th width="100">Cant.</th><th width="40"></th></tr></thead>
                <tbody id="insumos-container"></tbody>
            </table>

            <div class="section-header" style="margin-top:40px"><span class="section-title">Cierre de Orden</span></div>
            <div class="grid-2">
                <div><label>Revisado Por</label><input type="text" id="revisadoPor"></div>
                <div><label>Fecha Revisi√≥n</label><input type="date" id="fechaRevision"></div>
                <div class="full"><label>Recibido Por</label><input type="text" id="recibidoPor"></div>
                <div class="full"><label>Observaciones</label><textarea id="observaciones"></textarea></div>
            </div>
        </div>

        <div class="form-footer">
            <button type="submit" class="btn-save" id="btnEnviar">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                Guardar Orden
            </button>
        </div>
    </form>
</div>

<script>
    const API_BASE = 'http://127.0.0.1:8000';
    const rowTemplates = {
        tareas: (i, d={}) => `<tr><td style="text-align:center;font-weight:bold;color:#ccc">${i}</td><td><input type="text" name="tarea-detalle" class="table-input" value="${d.detalle||''}"></td><td><input type="number" name="tarea-tiempoEstimado" class="table-input" value="${d.tiempo_estimado||''}"></td><td><div style="display:flex; gap:8px"><input type="number" name="tarea-tiempoReal" class="table-input" value="${d.tiempo_real||''}"><button type="button" class="btn-del" onclick="removeRow(this)">√ó</button></div></td></tr>`,
        repuestos: (i, d={}) => `<tr><td style="text-align:center;font-weight:bold;color:#ccc">${i}</td><td><input type="text" class="table-input bg-green" name="repuesto-codigo" value="${d.codigo||''}"></td><td><input type="text" class="table-input bg-yellow" name="repuesto-desc" value="${d.descripcion||''}"></td><td><div style="display:flex; gap:8px"><input type="number" name="repuesto-cantidad" class="table-input" value="${d.cantidad||''}"><button type="button" class="btn-del" onclick="removeRow(this)">√ó</button></div></td></tr>`,
        insumos: (i, d={}) => `<tr><td style="text-align:center;font-weight:bold;color:#ccc">${i}</td><td><input type="text" class="table-input bg-green" name="insumo-codigo" value="${d.codigo||''}"></td><td><input type="text" class="table-input bg-yellow" name="insumo-desc" value="${d.descripcion||''}"></td><td><div style="display:flex; gap:8px"><input type="number" name="insumo-cantidad" class="table-input" value="${d.cantidad||''}"><button type="button" class="btn-del" onclick="removeRow(this)">√ó</button></div></td></tr>`
    };

    function addRow(type, data) {
        const c = document.getElementById(type+'-container');
        const add = (d) => c.insertAdjacentHTML('beforeend', rowTemplates[type](c.children.length+1, d));
        if(data && data.length) data.forEach(add); else add();
    }
    function removeRow(btn) {
        const row = btn.closest('tr');
        if(row.parentElement.children.length > 1 && confirm('¬øBorrar fila?')) {
            const p = row.parentElement; row.remove();
            Array.from(p.children).forEach((r, i) => r.firstElementChild.textContent = i+1);
        } else if(row.parentElement.children.length <= 1) alert("M√≠nimo una fila.");
    }
    function getTableData(type, fields) {
        return Array.from(document.querySelectorAll(`#${type}-container tr`)).map(row => {
            let obj = {}, hasVal = false;
            Object.entries(fields).forEach(([k, name]) => {
                let val = row.querySelector(`[name="${name}"]`)?.value;
                if(val) hasVal = true;
                obj[k] = (k.includes('cantidad')||k.includes('tiempo')) ? parseInt(val)||0 : val;
            });
            return hasVal ? obj : null;
        }).filter(x => x);
    }
    function getVal(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }

    document.getElementById('ordenTrabajoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnEnviar');
        btn.disabled = true; btn.textContent = 'Guardando...';
        const payload = {
            numero_ot: getVal('numeroOt'), fechaCreacion: getVal('fechaCreacion'), equipo_maquina: getVal('equipoMaquina'), descripcion: getVal('descripcion'), marca: getVal('marca'), ubicacion: getVal('ubicacion'), modelo: getVal('modelo'), tipo_accion: getVal('tipoAccion'), odometro: getVal('odometro'), responsable_ejecucion: getVal('responsableEjecucion'), fechaPlanificada: getVal('fechaPlanificada'), supervisor: getVal('supervisor'), revisadoPor: getVal('revisadoPor'), fechaRevision: getVal('fechaRevision'), recibidoPor: getVal('recibidoPor'), observaciones: getVal('observaciones'),
            tareas: getTableData('tareas', {detalle:'tarea-detalle', tiempo_estimado:'tarea-tiempoEstimado', tiempo_real:'tarea-tiempoReal'}),
            repuestos: getTableData('repuestos', {codigo:'repuesto-codigo', descripcion:'repuesto-desc', cantidad:'repuesto-cantidad'}),
            insumos: getTableData('insumos', {codigo:'insumo-codigo', descripcion:'insumo-desc', cantidad:'insumo-cantidad'})
        };
        try {
            const res = await fetch(`${API_BASE}/recibir-orden/`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const json = await res.json();
            if(json.status === 'success') {
                alert('‚úÖ GUARDADO');
                if(!location.search.includes('editar')) location.reload();
            } else throw new Error(json.message);
        } catch(e) { alert('Error: '+e.message); }
        finally { btn.disabled = false; btn.textContent = 'Guardar Orden'; }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const editId = new URLSearchParams(location.search).get('editar');
        if(editId) {
            try {
                const res = await fetch(`${API_BASE}/api/detalle-ot/${editId}/`);
                if(res.ok) {
                    const data = await res.json();
                    const fields = ['numeroOt','fechaCreacion','equipoMaquina','descripcion','marca','ubicacion','modelo','tipoAccion','odometro','responsableEjecucion','fechaPlanificada','supervisor','revisadoPor','fechaRevision','recibidoPor','observaciones'];
                    fields.forEach(id => {
                        const el = document.getElementById(id);
                        const k = id === 'numeroOt' ? 'numero_ot' : id;
                        if(el) el.value = data[k] || '';
                    });
                    ['tareas','repuestos','insumos'].forEach(t => {
                        document.getElementById(`${t}-container`).innerHTML = '';
                        addRow(t, data[t].length ? data[t] : null);
                    });
                    document.getElementById('btnEnviar').textContent = 'üîÑ Actualizar Orden';
                }
            } catch(e) {}
        } else {
            document.getElementById('fechaCreacion').value = new Date().toISOString().split('T')[0];
            try {
                const res = await fetch(`${API_BASE}/api/siguiente-folio/`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('numeroOt').value = data.nuevo_folio;
                } else throw new Error();
            } catch {
                const now = new Date();
                document.getElementById('numeroOt').value = `OT-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate()}-${now.getHours()}${now.getMinutes()}`;
            }
            addRow('tareas'); addRow('repuestos'); addRow('insumos');
        }
    });
</script>
</body>
</html>